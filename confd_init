#!/bin/bash

TOML=/etc/confd/conf.d/haproxy.toml
TMPL=/etc/confd/templates/haproxy.tmpl

. /etc/haproxy/haproxy.ini
if [ -z "$ADMIN_PASSWORD" ]; then
  ADMIN_PASSWORD=admin
fi

LBSTRING="{{ lb := make(map[string]string) }}"
for lb in $LB_INSTANCES; do
  app=$(echo $lb|cut -d: -f1)
  svc=$(echo $lb|cut -d: -f2)
  dom=$(echo $lb|cut -d: -f3)
  LBSTRING="${LBSTRING}\n{{ lb[\"${app}-${svc}\"] = \"${dom}\" }}"
done

LBSTRING="$LBSTRING\n{{ passwd := \"${ADMIN_PASSWORD}\""
sed -i -e "1i $LBSTRING" $TMPL

for ((i=0; i<10; i++)); do
  confd -onetime -node $CSPHERE_NODE_IP:2379 -config-file ${TOML} && break
  echo "[haproxy] waiting for confd to create initial haproxy configuration."
  sleep 1
done
